<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Smart Cloud Dashboard — MVP</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family: Arial; margin:20px;}
    table{border-collapse:collapse;width:100%}
    th,td{padding:8px;border:1px solid #ddd; text-align:left}
    button{padding:6px 10px;margin:2px}
    canvas{display:block}
  </style>
</head>
<body>
  <h1>Smart Cloud Dashboard — Minimal</h1>
  <div id="instances">Loading instances...</div>

<script>
const charts = {};

async function fetchInstances(){
  const res = await fetch('/api/instances');
  const data = await res.json();
  const container = document.getElementById('instances');
  if (data.error){ container.innerText = 'Error: ' + JSON.stringify(data.error); return; }
  if (!data.length){ container.innerText = 'No instances found.'; return; }

  let html = '<table><tr><th>InstanceId</th><th>State</th><th>Type</th><th>Public IP</th><th>CPU %</th><th>Actions</th></tr>';
  data.forEach(i => {
    const cid = 'cpu_' + i.InstanceId;
    html += `<tr>
      <td>${i.InstanceId}</td>
      <td>${i.State}</td>
      <td>${i.InstanceType}</td>
      <td>${i.PublicIp || '-'}</td>
      <td><canvas id="${cid}" width="120" height="50"></canvas></td>
      <td>
        <button onclick="action('${i.InstanceId}','start')">Start</button>
        <button onclick="action('${i.InstanceId}','stop')">Stop</button>
      </td>
    </tr>`;
  });
  html += '</table>';
  container.innerHTML = html;

  data.forEach(i => updateCPU(i.InstanceId));
}

async function updateCPU(id){
  try {
    const res = await fetch(`/api/cpu/${id}`);
    const r = await res.json();
    const canvas = document.getElementById('cpu_' + id);
    if (!canvas) return;
    const cpu = (r && r.cpu !== null && r.cpu !== undefined) ? Number(r.cpu.toFixed(1)) : 0;

    if (charts[id]) {
      charts[id].data.datasets[0].data = [cpu];
      charts[id].data.datasets[0].backgroundColor =
        cpu > 80 ? 'rgba(255,99,132,0.7)' :
        cpu > 60 ? 'rgba(255,159,64,0.7)' :
        'rgba(75,192,192,0.7)';
      charts[id].update();
    } else {
      const ctx = canvas.getContext('2d');
      charts[id] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['CPU'],
          datasets: [{
            label: '%',
            data: [cpu],
            backgroundColor: 'rgba(75,192,192,0.7)',
            borderWidth: 1
          }]
        },
        options: {
          scales: { y: { min: 0, max: 100 } },
          plugins: { legend: { display: false } }
        }
      });
    }
    setTimeout(() => updateCPU(id), 30000);
  } catch (e) {
    console.error(e);
    setTimeout(() => updateCPU(id), 30000);
  }
}

async function action(id, cmd){
  if(!confirm('Are you sure you want to ' + cmd + ' instance ' + id + ' ?')) return;
  const res = await fetch(`/api/instance/${id}/${cmd}`, {method:'POST'});
  const r = await res.json();
  alert(JSON.stringify(r));
  setTimeout(fetchInstances, 2000);
}

fetchInstances();
</script>
</body>
</html>
